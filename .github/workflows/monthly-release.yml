name: Monthly Release

on:
  schedule:
    # Run daily on days 28-31 at 23:59 UTC
    # The workflow will check if it's the last day of the month
    # Cron format: minute hour day month day-of-week
    - cron: '59 23 28-31 * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (YYYY-MM format, optional - will auto-calculate if not provided)'
        required: false
        type: string
      force:
        description: 'Force release even if no changes detected'
        required: false
        type: boolean
        default: false

jobs:
  monthly-release:
    name: Monthly Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
      pull-requests: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Determine next version
        id: version
        run: |
          # If version provided via input, use it
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "Using provided version: $VERSION"
          else
            # Calculate next month version (YYYY-MM format)
            # Get current date in UTC
            CURRENT_YEAR=$(date -u +%Y)
            CURRENT_MONTH=$(date -u +%m)
            CURRENT_DAY=$(date -u +%d)
            
            # For scheduled runs, check if it's the last day of the month
            if [ "${{ github.event_name }}" = "schedule" ]; then
              # Check if tomorrow is in a different month (meaning today is last day)
              TOMORROW_MONTH=$(date -u -d "tomorrow" +%m 2>/dev/null || date -u -v+1d +%m 2>/dev/null || echo "")
              
              if [ -n "$TOMORROW_MONTH" ] && [ "$TOMORROW_MONTH" != "$CURRENT_MONTH" ]; then
                # Today is the last day of the month, use current month
                VERSION="${CURRENT_YEAR}-${CURRENT_MONTH}"
                echo "‚úÖ Last day of month detected (today: ${CURRENT_DAY}, tomorrow is month ${TOMORROW_MONTH})"
                echo "‚úÖ Creating release for ${VERSION}"
              else
                # Not the last day, but we'll still set version (skip logic will handle it)
                VERSION="${CURRENT_YEAR}-${CURRENT_MONTH}"
                echo "‚ö†Ô∏è  Not the last day of month (today: day ${CURRENT_DAY} of month ${CURRENT_MONTH})"
                echo "‚ö†Ô∏è  Will skip release creation"
                echo "is_last_day=false" >> $GITHUB_OUTPUT
              fi
              
              if [ -z "$TOMORROW_MONTH" ] || [ "$TOMORROW_MONTH" = "$CURRENT_MONTH" ]; then
                echo "is_last_day=false" >> $GITHUB_OUTPUT
              else
                echo "is_last_day=true" >> $GITHUB_OUTPUT
              fi
            else
              # For manual runs, use current month
              VERSION="${CURRENT_YEAR}-${CURRENT_MONTH}"
              echo "Manual trigger, using current month: ${VERSION}"
            fi
            
            echo "Calculated version: $VERSION"
          fi
          
          # Validate version format (YYYY-MM)
          if ! echo "$VERSION" | grep -qE '^[0-9]{4}-[0-9]{2}$'; then
            echo "‚ùå Invalid version format: $VERSION (expected YYYY-MM)"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Version determined: $VERSION"
      
      - name: Check current VERSION file
        id: current_version
        run: |
          CURRENT_VERSION=$(cat VERSION 2>/dev/null || echo "")
          if [ -z "$CURRENT_VERSION" ]; then
            echo "‚ö†Ô∏è  No VERSION file found, will create one"
            echo "current_version=" >> $GITHUB_OUTPUT
            echo "has_version=false" >> $GITHUB_OUTPUT
          else
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "has_version=true" >> $GITHUB_OUTPUT
            echo "Current VERSION: $CURRENT_VERSION"
          fi
      
      - name: Check if version already exists
        id: version_check
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"
          CURRENT_VERSION="${{ steps.current_version.outputs.current_version }}"
          IS_LAST_DAY="${{ steps.version.outputs.is_last_day }}"
          FORCE="${{ github.event.inputs.force }}"
          
          # For scheduled runs, only proceed if it's the last day of month
          if [ "${{ github.event_name }}" = "schedule" ] && [ "$IS_LAST_DAY" != "true" ] && [ "$FORCE" != "true" ]; then
            echo "‚ö†Ô∏è  Not the last day of the month"
            echo "‚ö†Ô∏è  Skipping release (scheduled runs only execute on last day)"
            echo "should_skip=true" >> $GITHUB_OUTPUT
          elif [ "$NEW_VERSION" = "$CURRENT_VERSION" ] && [ "$FORCE" != "true" ]; then
            echo "‚ö†Ô∏è  Version $NEW_VERSION already exists in VERSION file"
            echo "‚ö†Ô∏è  Skipping release (use 'force' input to override)"
            echo "should_skip=true" >> $GITHUB_OUTPUT
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Find last release tag
        id: last_release
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "No previous release tag found"
            echo "last_tag=" >> $GITHUB_OUTPUT
            echo "has_last_tag=false" >> $GITHUB_OUTPUT
          else
            echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
            echo "has_last_tag=true" >> $GITHUB_OUTPUT
            echo "Last release tag: $LAST_TAG"
          fi
      
      - name: Check for changes
        id: changes
        if: steps.version_check.outputs.should_skip == 'false'
        run: |
          LAST_TAG="${{ steps.last_release.outputs.last_tag }}"
          FORCE="${{ github.event.inputs.force }}"
          
          if [ -z "$LAST_TAG" ]; then
            echo "No previous release, assuming changes exist"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "0")
          else
            COMMIT_COUNT=$(git rev-list --count ${LAST_TAG}..HEAD 2>/dev/null || echo "0")
            if [ "$COMMIT_COUNT" = "0" ] && [ "$FORCE" != "true" ]; then
              echo "‚ö†Ô∏è  No commits since last release ($LAST_TAG)"
              echo "‚ö†Ô∏è  Skipping release (use 'force' input to override)"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ Found $COMMIT_COUNT commits since $LAST_TAG"
              echo "has_changes=true" >> $GITHUB_OUTPUT
            fi
          fi
          
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
      
      - name: Generate changelog
        id: changelog
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          LAST_TAG="${{ steps.last_release.outputs.last_tag }}"
          
          # Get commit list
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
            COMMIT_RANGE="HEAD"
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
            COMMIT_RANGE="${LAST_TAG}..HEAD"
          fi
          
          # Get file statistics
          if [ -z "$LAST_TAG" ]; then
            FILES_CHANGED=$(git diff --stat HEAD~1 HEAD 2>/dev/null || echo "")
            FILES_ADDED=$(git diff --name-status --diff-filter=A HEAD~1 HEAD 2>/dev/null | wc -l || echo "0")
            FILES_MODIFIED=$(git diff --name-status --diff-filter=M HEAD~1 HEAD 2>/dev/null | wc -l || echo "0")
            FILES_DELETED=$(git diff --name-status --diff-filter=D HEAD~1 HEAD 2>/dev/null | wc -l || echo "0")
          else
            FILES_CHANGED=$(git diff --stat ${LAST_TAG}..HEAD 2>/dev/null || echo "")
            FILES_ADDED=$(git diff --name-status --diff-filter=A ${LAST_TAG}..HEAD 2>/dev/null | wc -l || echo "0")
            FILES_MODIFIED=$(git diff --name-status --diff-filter=M ${LAST_TAG}..HEAD 2>/dev/null | wc -l || echo "0")
            FILES_DELETED=$(git diff --name-status --diff-filter=D ${LAST_TAG}..HEAD 2>/dev/null | wc -l || echo "0")
          fi
          
          # Get lines changed
          if [ -z "$LAST_TAG" ]; then
            LINES_STAT=$(git diff --shortstat HEAD~1 HEAD 2>/dev/null || echo "")
          else
            LINES_STAT=$(git diff --shortstat ${LAST_TAG}..HEAD 2>/dev/null || echo "")
          fi
          
          # Generate diff URL
          REPO_URL="${{ github.repository }}"
          if [ -z "$LAST_TAG" ]; then
            DIFF_URL="https://github.com/${REPO_URL}/compare/HEAD~1...HEAD"
          else
            DIFF_URL="https://github.com/${REPO_URL}/compare/${LAST_TAG}...HEAD"
          fi
          
          # Create changelog
          CHANGELOG="## Release Notes - ${VERSION//-/.}

**Release Date:** $(date -u +"%B %d, %Y")  
**Version:** ${VERSION//-/.}  
**Previous Version:** ${{ steps.current_version.outputs.current_version || 'N/A' }}

---

## üìà Statistics

- **Commits:** ${{ steps.changes.outputs.commit_count }} commits since ${LAST_TAG:-'beginning'}
- **Files Changed:** 
  - Added: ${FILES_ADDED} files
  - Modified: ${FILES_MODIFIED} files
  - Deleted: ${FILES_DELETED} files
- **Lines Changed:** ${LINES_STAT:-'N/A'}
- **Contributors:** 1

---

## üîÑ Changes Since Last Release

### Commits
${COMMITS:-'No commits found'}

### Diff Summary
[View full diff](${DIFF_URL})

---

## üìù Detailed Changelog

### Added
${COMMITS}

### Changed
See diff for detailed changes.

---

## üîó Related

- [Full Diff](${DIFF_URL})
- [Documentation](https://docs.eco-balance.cc/)
- [GitHub Release](https://github.com/${REPO_URL}/releases/tag/v${VERSION})
"
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Also save to file for release notes
          echo "$CHANGELOG" > release-notes-temp.md
      
      - name: Create release notes directory
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_DIR="_versions/v${VERSION//-/.}"
          mkdir -p "$VERSION_DIR"
          echo "Created directory: $VERSION_DIR"
          echo "version_dir=$VERSION_DIR" >> $GITHUB_OUTPUT
      
      - name: Save release notes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_DIR="${{ steps.changelog.outputs.version_dir || '_versions/v'${VERSION//-/.} }}"
          if [ -f "release-notes-temp.md" ]; then
            cp release-notes-temp.md "${VERSION_DIR}/RELEASE_NOTES.md"
            echo "‚úÖ Release notes saved to ${VERSION_DIR}/RELEASE_NOTES.md"
          fi
      
      - name: Update VERSION file
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "$VERSION" > VERSION
          echo "‚úÖ Updated VERSION file to: $VERSION"
          git add VERSION
          
          # Add release notes if created
          VERSION_DIR="_versions/v${VERSION//-/.}"
          if [ -f "${VERSION_DIR}/RELEASE_NOTES.md" ]; then
            git add "${VERSION_DIR}/RELEASE_NOTES.md"
            echo "‚úÖ Added release notes to git"
          fi
      
      - name: Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git commit -m "chore: prepare release v${VERSION}

- Update VERSION to ${VERSION}
- Add release notes for ${VERSION}
- Generated by monthly-release workflow"
          
          git push origin HEAD:main || {
            echo "‚ö†Ô∏è  Failed to push, might be due to branch protection"
            echo "‚ö†Ô∏è  Changes are ready but need manual push or PR"
            exit 1
          }
          echo "‚úÖ Changes committed and pushed"
      
      - name: Summary
        if: always()
        run: |
          echo "## Monthly Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.version_check.outputs.should_skip }}" = "true" ]; then
            echo "‚ö†Ô∏è **Skipped:** Version ${{ steps.version.outputs.version }} already exists" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Use the 'force' input to override." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.changes.outputs.has_changes }}" != "true" ]; then
            echo "‚ö†Ô∏è **Skipped:** No changes detected since last release" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Use the 'force' input to create release anyway." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Release Prepared:** v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Commits: ${{ steps.changes.outputs.commit_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- VERSION file updated" >> $GITHUB_STEP_SUMMARY
            echo "- Release notes created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The deployment and release creation will be triggered automatically." >> $GITHUB_STEP_SUMMARY
          fi

