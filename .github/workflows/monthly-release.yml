name: Monthly Release

on:
  schedule:
    # Run daily on days 28-31 at 23:59 UTC
    # The workflow will check if it's the last day of the month
    # Cron format: minute hour day month day-of-week
    - cron: '59 23 28-31 * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (YYYY-MM format, optional - will auto-calculate if not provided)'
        required: false
        type: string
      force:
        description: 'Force release even if no changes detected'
        required: false
        type: boolean
        default: false

jobs:
  monthly-release:
    name: Monthly Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Determine next version
        id: version
        run: |
          # If version provided via input, use it
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "Using provided version: $VERSION"
          else
            # Calculate next month version (YYYY-MM format)
            # Get current date in UTC
            CURRENT_YEAR=$(date -u +%Y)
            CURRENT_MONTH=$(date -u +%m)
            CURRENT_DAY=$(date -u +%d)
            
            # For scheduled runs, check if it's the last day of the month
            if [ "${{ github.event_name }}" = "schedule" ]; then
              # Check if tomorrow is in a different month (meaning today is last day)
              TOMORROW_MONTH=$(date -u -d "tomorrow" +%m 2>/dev/null || date -u -v+1d +%m 2>/dev/null || echo "")
              
              if [ -n "$TOMORROW_MONTH" ] && [ "$TOMORROW_MONTH" != "$CURRENT_MONTH" ]; then
                # Today is the last day of the month, use current month
                VERSION="${CURRENT_YEAR}-${CURRENT_MONTH}"
                echo "âœ… Last day of month detected (today: ${CURRENT_DAY}, tomorrow is month ${TOMORROW_MONTH})"
                echo "âœ… Creating release for ${VERSION}"
              else
                # Not the last day, but we'll still set version (skip logic will handle it)
                VERSION="${CURRENT_YEAR}-${CURRENT_MONTH}"
                echo "âš ï¸  Not the last day of month (today: day ${CURRENT_DAY} of month ${CURRENT_MONTH})"
                echo "âš ï¸  Will skip release creation"
                echo "is_last_day=false" >> $GITHUB_OUTPUT
              fi
              
              if [ -z "$TOMORROW_MONTH" ] || [ "$TOMORROW_MONTH" = "$CURRENT_MONTH" ]; then
                echo "is_last_day=false" >> $GITHUB_OUTPUT
              else
                echo "is_last_day=true" >> $GITHUB_OUTPUT
              fi
            else
              # For manual runs, use current month
              VERSION="${CURRENT_YEAR}-${CURRENT_MONTH}"
              echo "Manual trigger, using current month: ${VERSION}"
            fi
            
            echo "Calculated version: $VERSION"
          fi
          
          # Validate version format (YYYY-MM)
          if ! echo "$VERSION" | grep -qE '^[0-9]{4}-[0-9]{2}$'; then
            echo "âŒ Invalid version format: $VERSION (expected YYYY-MM)"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Version determined: $VERSION"
      
      - name: Check current VERSION file
        id: current_version
        run: |
          CURRENT_VERSION=$(cat VERSION 2>/dev/null || echo "")
          if [ -z "$CURRENT_VERSION" ]; then
            echo "âš ï¸  No VERSION file found, will create one"
            echo "current_version=" >> $GITHUB_OUTPUT
            echo "has_version=false" >> $GITHUB_OUTPUT
          else
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "has_version=true" >> $GITHUB_OUTPUT
            echo "Current VERSION: $CURRENT_VERSION"
          fi
      
      - name: Check if version already exists
        id: version_check
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"
          CURRENT_VERSION="${{ steps.current_version.outputs.current_version }}"
          IS_LAST_DAY="${{ steps.version.outputs.is_last_day }}"
          FORCE="${{ github.event.inputs.force }}"
          
          # For scheduled runs, only proceed if it's the last day of month
          if [ "${{ github.event_name }}" = "schedule" ] && [ "$IS_LAST_DAY" != "true" ] && [ "$FORCE" != "true" ]; then
            echo "âš ï¸  Not the last day of the month"
            echo "âš ï¸  Skipping release (scheduled runs only execute on last day)"
            echo "should_skip=true" >> $GITHUB_OUTPUT
          elif [ "$NEW_VERSION" = "$CURRENT_VERSION" ] && [ "$FORCE" != "true" ]; then
            echo "âš ï¸  Version $NEW_VERSION already exists in VERSION file"
            echo "âš ï¸  Skipping release (use 'force' input to override)"
            echo "should_skip=true" >> $GITHUB_OUTPUT
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Find last release tag
        id: last_release
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            echo "No previous release tag found"
            echo "last_tag=" >> $GITHUB_OUTPUT
            echo "has_last_tag=false" >> $GITHUB_OUTPUT
          else
            echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
            echo "has_last_tag=true" >> $GITHUB_OUTPUT
            echo "Last release tag: $LAST_TAG"
          fi
      
      - name: Check for changes
        id: changes
        if: steps.version_check.outputs.should_skip == 'false'
        run: |
          LAST_TAG="${{ steps.last_release.outputs.last_tag }}"
          FORCE="${{ github.event.inputs.force }}"
          
          if [ -z "$LAST_TAG" ]; then
            echo "No previous release, assuming changes exist"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "0")
          else
            COMMIT_COUNT=$(git rev-list --count ${LAST_TAG}..HEAD 2>/dev/null || echo "0")
            if [ "$COMMIT_COUNT" = "0" ] && [ "$FORCE" != "true" ]; then
              echo "âš ï¸  No commits since last release ($LAST_TAG)"
              echo "âš ï¸  Skipping release (use 'force' input to override)"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            else
              echo "âœ… Found $COMMIT_COUNT commits since $LAST_TAG"
              echo "has_changes=true" >> $GITHUB_OUTPUT
            fi
          fi
          
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT
      
      - name: Generate changelog
        id: changelog
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          LAST_TAG="${{ steps.last_release.outputs.last_tag }}"
          COMMIT_COUNT="${{ steps.changes.outputs.commit_count }}"
          
          # Get commit list
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
            COMMIT_RANGE="HEAD"
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
            COMMIT_RANGE="${LAST_TAG}..HEAD"
          fi
          
          # Get file statistics
          if [ -z "$LAST_TAG" ]; then
            FILES_CHANGED=$(git diff --stat HEAD~1 HEAD 2>/dev/null || echo "")
            FILES_ADDED=$(git diff --name-status --diff-filter=A HEAD~1 HEAD 2>/dev/null | wc -l || echo "0")
            FILES_MODIFIED=$(git diff --name-status --diff-filter=M HEAD~1 HEAD 2>/dev/null | wc -l || echo "0")
            FILES_DELETED=$(git diff --name-status --diff-filter=D HEAD~1 HEAD 2>/dev/null | wc -l || echo "0")
          else
            FILES_CHANGED=$(git diff --stat ${LAST_TAG}..HEAD 2>/dev/null || echo "")
            FILES_ADDED=$(git diff --name-status --diff-filter=A ${LAST_TAG}..HEAD 2>/dev/null | wc -l || echo "0")
            FILES_MODIFIED=$(git diff --name-status --diff-filter=M ${LAST_TAG}..HEAD 2>/dev/null | wc -l || echo "0")
            FILES_DELETED=$(git diff --name-status --diff-filter=D ${LAST_TAG}..HEAD 2>/dev/null | wc -l || echo "0")
          fi
          
          # Get lines changed
          if [ -z "$LAST_TAG" ]; then
            LINES_STAT=$(git diff --shortstat HEAD~1 HEAD 2>/dev/null || echo "")
          else
            LINES_STAT=$(git diff --shortstat ${LAST_TAG}..HEAD 2>/dev/null || echo "")
          fi
          
          # Generate diff URL
          REPO_URL="${{ github.repository }}"
          if [ -z "$LAST_TAG" ]; then
            DIFF_URL="https://github.com/${REPO_URL}/compare/HEAD~1...HEAD"
          else
            DIFF_URL="https://github.com/${REPO_URL}/compare/${LAST_TAG}...HEAD"
          fi
          
          # Get release date
          RELEASE_DATE=$(date -u +"%B %d, %Y")
          
          # Get previous version
          PREVIOUS_VERSION="${{ steps.current_version.outputs.current_version }}"
          if [ -z "$PREVIOUS_VERSION" ]; then
            PREVIOUS_VERSION="N/A"
          fi
          
          # Create changelog - write directly to GITHUB_OUTPUT to avoid YAML parser issues
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "## Release Notes - ${VERSION//-/.}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "**Release Date:** ${RELEASE_DATE}" >> $GITHUB_OUTPUT
          echo "**Version:** ${VERSION//-/.}" >> $GITHUB_OUTPUT
          echo "**Previous Version:** ${PREVIOUS_VERSION}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "---" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ðŸ“ˆ Statistics" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "- **Commits:** ${COMMIT_COUNT} commits since ${LAST_TAG:-'beginning'}" >> $GITHUB_OUTPUT
          echo "- **Files Changed:**" >> $GITHUB_OUTPUT
          echo "  - Added: ${FILES_ADDED} files" >> $GITHUB_OUTPUT
          echo "  - Modified: ${FILES_MODIFIED} files" >> $GITHUB_OUTPUT
          echo "  - Deleted: ${FILES_DELETED} files" >> $GITHUB_OUTPUT
          echo "- **Lines Changed:** ${LINES_STAT:-'N/A'}" >> $GITHUB_OUTPUT
          echo "- **Contributors:** 1" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "---" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ðŸ”„ Changes Since Last Release" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### Commits" >> $GITHUB_OUTPUT
          if [ -n "$COMMITS" ]; then
            echo "$COMMITS" >> $GITHUB_OUTPUT
          else
            echo "No commits found" >> $GITHUB_OUTPUT
          fi
          echo "" >> $GITHUB_OUTPUT
          echo "### Diff Summary" >> $GITHUB_OUTPUT
          echo "[View full diff](${DIFF_URL})" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "---" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ðŸ“ Detailed Changelog" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### Added" >> $GITHUB_OUTPUT
          if [ -n "$COMMITS" ]; then
            echo "$COMMITS" >> $GITHUB_OUTPUT
          else
            echo "No commits found" >> $GITHUB_OUTPUT
          fi
          echo "" >> $GITHUB_OUTPUT
          echo "### Changed" >> $GITHUB_OUTPUT
          echo "See diff for detailed changes." >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "---" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ðŸ”— Related" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "- [Full Diff](${DIFF_URL})" >> $GITHUB_OUTPUT
          echo "- [Documentation](https://docs.eco-balance.cc/)" >> $GITHUB_OUTPUT
          echo "- [GitHub Release](https://github.com/${REPO_URL}/releases/tag/v${VERSION})" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Also save to file for release notes (build the content for the file)
          {
            echo "## Release Notes - ${VERSION//-/.}"
            echo ""
            echo "**Release Date:** ${RELEASE_DATE}"
            echo "**Version:** ${VERSION//-/.}"
            echo "**Previous Version:** ${PREVIOUS_VERSION}"
            echo ""
            echo "---"
            echo ""
            echo "## ðŸ“ˆ Statistics"
            echo ""
            echo "- **Commits:** ${COMMIT_COUNT} commits since ${LAST_TAG:-'beginning'}"
            echo "- **Files Changed:**"
            echo "  - Added: ${FILES_ADDED} files"
            echo "  - Modified: ${FILES_MODIFIED} files"
            echo "  - Deleted: ${FILES_DELETED} files"
            echo "- **Lines Changed:** ${LINES_STAT:-'N/A'}"
            echo "- **Contributors:** 1"
            echo ""
            echo "---"
            echo ""
            echo "## ðŸ”„ Changes Since Last Release"
            echo ""
            echo "### Commits"
            if [ -n "$COMMITS" ]; then
              echo "$COMMITS"
            else
              echo "No commits found"
            fi
            echo ""
            echo "### Diff Summary"
            echo "[View full diff](${DIFF_URL})"
            echo ""
            echo "---"
            echo ""
            echo "## ðŸ“ Detailed Changelog"
            echo ""
            echo "### Added"
            if [ -n "$COMMITS" ]; then
              echo "$COMMITS"
            else
              echo "No commits found"
            fi
            echo ""
            echo "### Changed"
            echo "See diff for detailed changes."
            echo ""
            echo "---"
            echo ""
            echo "## ðŸ”— Related"
            echo ""
            echo "- [Full Diff](${DIFF_URL})"
            echo "- [Documentation](https://docs.eco-balance.cc/)"
            echo "- [GitHub Release](https://github.com/${REPO_URL}/releases/tag/v${VERSION})"
          } > release-notes-temp.md
      
      - name: Create release notes directory
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Get version and convert format from YYYY-MM to YYYY.MM for directory name
          VERSION="${{ steps.version.outputs.version }}"
          VERSION_DIR="_versions/v${VERSION//-/.}"
          mkdir -p "$VERSION_DIR"
          echo "Created directory: $VERSION_DIR"
          echo "version_dir=$VERSION_DIR" >> $GITHUB_OUTPUT
      
      - name: Save release notes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Convert version format from YYYY-MM to YYYY.MM for directory name
          VERSION_DOT="${VERSION//-/.}"
          VERSION_DIR="_versions/v${VERSION_DOT}"
          if [ -f "release-notes-temp.md" ]; then
            cp release-notes-temp.md "${VERSION_DIR}/RELEASE_NOTES.md"
            echo "âœ… Release notes saved to ${VERSION_DIR}/RELEASE_NOTES.md"
          fi
      
      - name: Update VERSION file
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "$VERSION" > VERSION
          echo "âœ… Updated VERSION file to: $VERSION"
          git add VERSION
          
          # Add release notes if created
          VERSION_DIR="_versions/v${VERSION//-/.}"
          if [ -f "${VERSION_DIR}/RELEASE_NOTES.md" ]; then
            git add "${VERSION_DIR}/RELEASE_NOTES.md"
            echo "âœ… Added release notes to git"
          fi
      
      - name: Commit changes
        id: commit
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CURRENT_BRANCH="${{ github.ref_name }}"
          RELEASE_BRANCH="release/${VERSION}"
          git commit -m "chore: prepare release v${VERSION}" -m "Update VERSION to ${VERSION}" -m "Add release notes for ${VERSION}" -m "Generated by monthly-release workflow"
          
          # When on main: push to a release branch and open PR (main is often protected)
          # Use --force so re-runs or existing release/YYYY-MM from a previous run are overwritten
          # When on another branch: push to that branch
          if [ "$CURRENT_BRANCH" = "main" ]; then
            git push origin HEAD:${RELEASE_BRANCH} --force || {
              echo "âš ï¸  Failed to push branch ${RELEASE_BRANCH}"
              exit 1
            }
            echo "release_branch=${RELEASE_BRANCH}" >> $GITHUB_OUTPUT
            echo "pr_created=true" >> $GITHUB_OUTPUT
            echo "âœ… Pushed branch ${RELEASE_BRANCH}"
          else
            git push origin HEAD:${CURRENT_BRANCH} || {
              echo "âš ï¸  Failed to push to ${CURRENT_BRANCH}"
              exit 1
            }
            echo "release_branch=${CURRENT_BRANCH}" >> $GITHUB_OUTPUT
            echo "pr_created=false" >> $GITHUB_OUTPUT
            echo "âœ… Changes committed and pushed to ${CURRENT_BRANCH}"
          fi
      
      - name: Create release PR
        id: create_pr
        if: steps.changes.outputs.has_changes == 'true' && steps.commit.outputs.pr_created == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_BRANCH="${{ steps.commit.outputs.release_branch }}"
          TITLE="chore: release v${VERSION}"
          BODY="## Monthly release v${VERSION}"$'\n\n'"Automated by the **Monthly Release** workflow. Merge this PR to:"$'\n'"- Update the deployed site (deploy runs on VERSION change on main)"$'\n'"- Create the GitHub release (release-automation runs on VERSION change)"$'\n\n'"*Generated by monthly-release workflow.*"
          REPO="${{ github.repository }}"
          
          # Try GitHub CLI first (gh prints PR URL to stdout on success)
          PR_URL=""
          GH_OUTPUT=$(gh pr create --base main --head "${RELEASE_BRANCH}" --title "${TITLE}" --body "${BODY}" 2>&1) || true
          if echo "$GH_OUTPUT" | grep -qE '^https://github\.com/'; then
            PR_URL=$(echo "$GH_OUTPUT" | grep -oE 'https://github\.com/[^ ]+')
          else
            echo "gh pr create output: $GH_OUTPUT"
          fi
          
          # Fallback: GitHub REST API (same token, sometimes more reliable in automation)
          if [ -z "$PR_URL" ]; then
            EXISTING=$(gh pr list --head "${RELEASE_BRANCH}" --base main --state open --json url -q '.[0].url' 2>/dev/null || echo "")
            if [ -n "$EXISTING" ]; then
              PR_URL="$EXISTING"
              echo "âœ… Release PR already open: $PR_URL"
            else
              echo "Trying GitHub API to create PR..."
              API_JSON=$(jq -n --arg title "${TITLE}" --arg head "${RELEASE_BRANCH}" --arg base "main" --arg body "${BODY}" '{title:$title, head:$head, base:$base, body:$body}')
              RESP=$(curl -sS -w "\n%{http_code}" -X POST \
                -H "Authorization: bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/repos/${REPO}/pulls" \
                -d "$API_JSON" 2>&1)
              HTTP_CODE=$(echo "$RESP" | tail -n1)
              BODY_RESP=$(echo "$RESP" | sed '$d')
              if [ "$HTTP_CODE" = "201" ]; then
                PR_URL=$(echo "$BODY_RESP" | jq -r '.html_url // empty')
                echo "âœ… Opened PR via API: $PR_URL"
              else
                echo "âš ï¸  API create PR failed (HTTP $HTTP_CODE): $BODY_RESP"
              fi
            fi
          fi
          
          if [ -n "$PR_URL" ]; then
            echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
            echo "âœ… Opened PR: $PR_URL"
          else
            echo "âš ï¸  Could not create PR. Ensure Settings â†’ Actions â†’ General â†’ Workflow permissions has 'Allow GitHub Actions to create and approve pull requests' enabled. Open PR manually: ${RELEASE_BRANCH} â†’ main"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## Monthly Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.version_check.outputs.should_skip }}" = "true" ]; then
            echo "âš ï¸ **Skipped:** Version ${{ steps.version.outputs.version }} already exists" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Use the 'force' input to override." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.changes.outputs.has_changes }}" != "true" ]; then
            echo "âš ï¸ **Skipped:** No changes detected since last release" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Use the 'force' input to create release anyway." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Release Prepared:** v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Commits: ${{ steps.changes.outputs.commit_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- VERSION file updated" >> $GITHUB_STEP_SUMMARY
            echo "- Release notes created" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ steps.create_pr.outputs.pr_url }}" ]; then
              echo "ðŸ“Ž **Merge the PR to complete release and trigger deployment:** ${{ steps.create_pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ steps.commit.outputs.pr_created }}" = "true" ]; then
              echo "ðŸ“Ž **Merge the release branch \`${{ steps.commit.outputs.release_branch }}\` into main to trigger deployment.**" >> $GITHUB_STEP_SUMMARY
            else
              echo "The deployment and release creation will be triggered when this branch is merged." >> $GITHUB_STEP_SUMMARY
            fi
          fi

