name: Branch Protection Check

concurrency:
  group: branch-protection-check
  cancel-in-progress: true

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  check-branch-protection:
    name: Verify Branch Protection
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 2  # Need at least 2 commits to check merge commits
      
      - name: Check if push is from PR merge
        id: check_merge
        run: |
          # Check if the latest commit is a merge commit from a PR
          # GitHub creates merge commits with message "Merge pull request #X from..."
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          
          if echo "$COMMIT_MSG" | grep -qE "^Merge pull request #[0-9]+"; then
            echo "✅ This is a PR merge commit, allowing push"
            echo "is_pr_merge=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Also check if it's a merge commit (has 2+ parents)
          PARENT_COUNT=$(git log -1 --pretty=%P | wc -w)
          if [ "$PARENT_COUNT" -ge 2 ]; then
            echo "✅ This is a merge commit, allowing push"
            echo "is_pr_merge=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if committer is GitHub (for squash merges)
          COMMITTER=$(git log -1 --pretty=%cn)
          if [ "$COMMITTER" = "GitHub" ]; then
            echo "✅ This is a GitHub merge (likely from PR), allowing push"
            echo "is_pr_merge=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "is_pr_merge=false" >> $GITHUB_OUTPUT
      
      - name: Block direct push
        if: steps.check_merge.outputs.is_pr_merge != 'true'
        run: |
          echo "⚠️ Direct push to main branch detected!"
          echo "❌ All changes must go through Pull Requests."
          echo "Please create a branch and open a PR instead."
          echo ""
          echo "Commit message: $(git log -1 --pretty=%B)"
          echo "Author: $(git log -1 --pretty=%an)"
          echo "Committer: $(git log -1 --pretty=%cn)"
          exit 1

  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Validate PR
        run: |
          echo "✅ PR validation passed"
          echo "Branch: ${{ github.head_ref }}"
          echo "Base: ${{ github.base_ref }}"
          
          if [ "${{ github.base_ref }}" != "main" ]; then
            echo "⚠️ Warning: PR is not targeting main branch"
          fi

