name: Branch Protection Check

concurrency:
  group: branch-protection-check
  cancel-in-progress: true

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  branch-protection:
    # Single job for both events; name kept for branch protection rules that require "Validate Pull Request"
    name: Validate Pull Request
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 2
      
      # On push to main: verify the push is from a PR merge (not a direct push)
      - name: Check if push is from PR merge
        id: check_merge
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if echo "$COMMIT_MSG" | grep -qE "^Merge pull request #[0-9]+"; then
            echo "✅ This is a PR merge commit, allowing push"
            echo "is_pr_merge=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          PARENT_COUNT=$(git log -1 --pretty=%P | wc -w)
          if [ "$PARENT_COUNT" -ge 2 ]; then
            echo "✅ This is a merge commit, allowing push"
            echo "is_pr_merge=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          COMMITTER=$(git log -1 --pretty=%cn)
          if [ "$COMMITTER" = "GitHub" ]; then
            echo "✅ This is a GitHub merge (likely from PR), allowing push"
            echo "is_pr_merge=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "is_pr_merge=false" >> $GITHUB_OUTPUT
      
      - name: Block direct push to main
        if: github.ref == 'refs/heads/main' && github.event_name == 'push' && steps.check_merge.outputs.is_pr_merge != 'true'
        run: |
          echo "⚠️ Direct push to main branch detected!"
          echo "❌ All changes must go through Pull Requests."
          exit 1
      
      # On pull_request: simple validation (required so branch protection sees a passing check)
      - name: Validate pull request
        if: github.event_name == 'pull_request'
        run: |
          echo "✅ PR validation passed (branch ${{ github.head_ref }} → ${{ github.base_ref }})"

